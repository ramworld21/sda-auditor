import { h } from "@stencil/core";
import { guid } from "../../utils";
import { formatDate, isValidDate } from "../dga-datepicker/dateUtils";
import { alertCircleSolidRoundedIcon } from "../../assets/icons/index";
export class DgaDateField {
    constructor() {
        this.placeholder = "DD/MM/YYYY";
        this.size = 'lg';
        this.variant = 'default';
        this.error = false;
        this.helperText = '';
        this.disabled = false;
        this.readonly = false;
        this.required = false;
        this.fullwidth = true;
        this.name = guid();
        this.value = '';
        this.isActive = false;
        this.isFocused = false;
        this.isDatepickerOpen = false;
        this.errorMessage = '';
        this.selectedDate = null;
        this.inputValue = '';
        this.handleInput = (event) => {
            var _a, _b;
            const input = event.target;
            this.inputValue = input.value;
            if (this.inputValue === '') {
                this.selectedDate = null;
                this.errorMessage = '';
                this.error = false;
                (_a = this.onChange) === null || _a === void 0 ? void 0 : _a.call(this, null);
                return;
            }
            if (isValidDate(this.inputValue)) {
                const [day, month, year] = this.inputValue.split('/').map(Number);
                this.selectedDate = new Date(year, month - 1, day);
                this.errorMessage = '';
                this.error = false;
                (_b = this.onChange) === null || _b === void 0 ? void 0 : _b.call(this, this.selectedDate);
            }
            else {
                this.errorMessage = 'Use DD/MM/YYYY format';
                this.error = true;
            }
        };
        this.handleFocus = () => {
            this.isFocused = true;
        };
        // Method to detect clicks outside
        this.handleClickOutside = (event) => {
            if (this.isDatepickerOpen &&
                this.inputContainerRef &&
                !this.inputContainerRef.contains(event.target) && // Click is outside input
                this.datepickerRef &&
                !this.datepickerRef.contains(event.target) // Click is outside datepicker popup
            ) {
                this.isDatepickerOpen = false;
                document.removeEventListener('click', this.handleClickOutside);
            }
        };
        // Modify handleOpenDatepickerPopup to add event listener
        this.handleOpenDatepickerPopup = () => {
            if (!this.readonly && !this.disabled) {
                this.isDatepickerOpen = true;
                document.addEventListener('click', this.handleClickOutside);
            }
        };
        // Modify handleDatepickerChange to remove event listener when selecting a date
        this.handleDatepickerChange = (event) => {
            var _a;
            this.selectedDate = event.detail;
            this.inputValue = formatDate(this.selectedDate);
            this.errorMessage = '';
            this.error = false;
            this.isDatepickerOpen = false;
            (_a = this.onChange) === null || _a === void 0 ? void 0 : _a.call(this, this.selectedDate);
            document.removeEventListener('click', this.handleClickOutside);
        };
        // Remove listener when closing due to blur
        this.handleBlur = () => {
            setTimeout(() => {
                var _a;
                if (!((_a = this.inputContainerRef) === null || _a === void 0 ? void 0 : _a.contains(document.activeElement))) {
                    this.isFocused = false;
                    this.isDatepickerOpen = false;
                    document.removeEventListener('click', this.handleClickOutside);
                    if (this.selectedDate) {
                        this.inputValue = formatDate(this.selectedDate);
                    }
                }
            }, 200);
        };
    }
    valueChanged(newValue, oldValue) {
        if (newValue !== oldValue) {
            this.inputEl['value'] = newValue;
        }
    }
    render() {
        const inputClasses = {
            'input': true,
            [`input--${this.size}`]: true,
            'input--error': this.error,
            [`input--${this.variant}`]: this.variant !== 'default',
            'active': this.isActive,
            'focus': this.isFocused,
            'input--disabled': this.disabled,
            'readOnly': this.readonly
        };
        return (h("div", { key: 'ac304baaf8ec1f5286a4be53a0c27704e620d269', class: { "dga-form-control": true, "dga-form-control--fullwidth": this.fullwidth } }, this.label &&
            h("dga-label", { key: 'd344f92666daf85ecd35ccde15062b8b7880a7a5', label: this.label, size: this.size, required: this.required, disabled: this.disabled }), h("div", { key: '780e5814287987da88862d34d711c4c7cbc99ca8', class: Object.keys(inputClasses).filter(key => inputClasses[key]).join(' '), ref: el => this.inputContainerRef = el }, this.icon && (h("span", { key: 'a6c322f7d04489ae651f215cd1d1a2d9a8516274', class: "input__icon" }, h("dga-icon", { key: '6353b218fcdefa15e192a68aecfa9efcd802773b', name: this.icon.name, variant: this.icon.variant, type: this.icon.type, size: 20 }))), h("input", { key: '58273bef7c00b54fa1946a11623e36d8c0ae8fd9', ref: (el) => (this.inputEl = el), name: this.name, value: this.inputValue, type: "text", class: "input__field", placeholder: this.placeholder, disabled: this.disabled, readOnly: this.readonly, required: this.required, onFocus: this.handleFocus, onBlur: this.handleBlur, onInput: this.handleInput, onMouseDown: () => this.isActive = true, onMouseUp: () => this.isActive = false, onMouseOut: () => this.isActive = false }), h("dga-button-v2", { key: 'c2816fa5c44e50a140db53a8074c90ae9923da30', variant: "transparent", iconOnly: true, leadIcon: true, leadIconProps: { name: 'calendar-03', variant: 'stroke', type: 'rounded' }, onClick: this.handleOpenDatepickerPopup }), this.error && (h("span", { key: '1073913a48e3f71726455f44507ec7eafbcf9964', class: "input__feedback-icon input__feedback-icon--error" }, h("dga-icon", { key: '63f3b2bd2bc1f7bc33e37a27051638686aa76f5d', icon: alertCircleSolidRoundedIcon })))), (this.errorMessage || this.helperText) &&
            h("dga-helper-text", { key: 'ef17a1f66dbbe5d99701ea4380f67ba6ccf334ab', helperText: this.errorMessage || this.helperText, error: this.error }), this.isDatepickerOpen &&
            h("div", { key: '464184bd4b93a54410994cb564b4bff4205b0302', class: "date-picker-dropdown", ref: el => this.datepickerRef = el }, h("dga-datepicker", Object.assign({ key: '8166078360cf22e4f197ae0fb674d37f5610237a' }, this.datepickerOptions, { value: this.selectedDate, onChange: this.handleDatepickerChange, style: { width: "fit-content", display: "block" } })))));
    }
    static get is() { return "dga-date-field"; }
    static get originalStyleUrls() {
        return {
            "$": ["dga-date-field.scss"]
        };
    }
    static get styleUrls() {
        return {
            "$": ["dga-date-field.css"]
        };
    }
    static get properties() {
        return {
            "label": {
                "type": "string",
                "attribute": "label",
                "mutable": false,
                "complexType": {
                    "original": "string",
                    "resolved": "string",
                    "references": {}
                },
                "required": false,
                "optional": true,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false
            },
            "placeholder": {
                "type": "string",
                "attribute": "placeholder",
                "mutable": false,
                "complexType": {
                    "original": "string",
                    "resolved": "string",
                    "references": {}
                },
                "required": false,
                "optional": true,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "\"DD/MM/YYYY\""
            },
            "size": {
                "type": "string",
                "attribute": "size",
                "mutable": false,
                "complexType": {
                    "original": "'md' | 'lg'",
                    "resolved": "\"lg\" | \"md\"",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "'lg'"
            },
            "variant": {
                "type": "string",
                "attribute": "variant",
                "mutable": false,
                "complexType": {
                    "original": "'default' | 'lighter' | 'darker'",
                    "resolved": "\"darker\" | \"default\" | \"lighter\"",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "'default'"
            },
            "error": {
                "type": "boolean",
                "attribute": "error",
                "mutable": false,
                "complexType": {
                    "original": "boolean",
                    "resolved": "boolean",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "false"
            },
            "helperText": {
                "type": "string",
                "attribute": "helper-text",
                "mutable": false,
                "complexType": {
                    "original": "string",
                    "resolved": "string",
                    "references": {}
                },
                "required": false,
                "optional": true,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "''"
            },
            "icon": {
                "type": "unknown",
                "attribute": "icon",
                "mutable": false,
                "complexType": {
                    "original": "Icon",
                    "resolved": "Icon",
                    "references": {
                        "Icon": {
                            "location": "import",
                            "path": "../dga-featured-icon/dga-featured-icon",
                            "id": "src/components/dga-featured-icon/dga-featured-icon.tsx::Icon"
                        }
                    }
                },
                "required": false,
                "optional": true,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false
            },
            "disabled": {
                "type": "boolean",
                "attribute": "disabled",
                "mutable": false,
                "complexType": {
                    "original": "boolean",
                    "resolved": "boolean",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "false"
            },
            "readonly": {
                "type": "boolean",
                "attribute": "readonly",
                "mutable": false,
                "complexType": {
                    "original": "boolean",
                    "resolved": "boolean",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "false"
            },
            "required": {
                "type": "boolean",
                "attribute": "required",
                "mutable": false,
                "complexType": {
                    "original": "boolean",
                    "resolved": "boolean",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "false"
            },
            "fullwidth": {
                "type": "boolean",
                "attribute": "fullwidth",
                "mutable": false,
                "complexType": {
                    "original": "boolean",
                    "resolved": "boolean",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "true"
            },
            "name": {
                "type": "string",
                "attribute": "name",
                "mutable": false,
                "complexType": {
                    "original": "string",
                    "resolved": "string",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "guid()"
            },
            "value": {
                "type": "string",
                "attribute": "value",
                "mutable": false,
                "complexType": {
                    "original": "string",
                    "resolved": "string",
                    "references": {}
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false,
                "reflect": false,
                "defaultValue": "''"
            },
            "onChange": {
                "type": "unknown",
                "attribute": "on-change",
                "mutable": false,
                "complexType": {
                    "original": "(date: Date | null) => void",
                    "resolved": "(date: Date) => void",
                    "references": {
                        "Date": {
                            "location": "global",
                            "id": "global::Date"
                        }
                    }
                },
                "required": false,
                "optional": true,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false
            },
            "datepickerOptions": {
                "type": "unknown",
                "attribute": "datepicker-options",
                "mutable": false,
                "complexType": {
                    "original": "DatepickerOptions",
                    "resolved": "DatepickerOptions",
                    "references": {
                        "DatepickerOptions": {
                            "location": "local",
                            "path": "/Users/mohamedaboelezz/projects/Azm-X/platform-code-cross-platform-storybook/packages/core/src/components/dga-date-field/dga-date-field.tsx",
                            "id": "src/components/dga-date-field/dga-date-field.tsx::DatepickerOptions"
                        }
                    }
                },
                "required": false,
                "optional": false,
                "docs": {
                    "tags": [],
                    "text": ""
                },
                "getter": false,
                "setter": false
            }
        };
    }
    static get states() {
        return {
            "isActive": {},
            "isFocused": {},
            "isDatepickerOpen": {},
            "errorMessage": {},
            "selectedDate": {},
            "inputValue": {}
        };
    }
    static get watchers() {
        return [{
                "propName": "value",
                "methodName": "valueChanged"
            }];
    }
}
